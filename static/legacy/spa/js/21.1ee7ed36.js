(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[21],{4179:function(t,e,a){"use strict";a.r(e);var i=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("q-page",{staticClass:"q-pa-lg"},[a("div",[a("q-card",[a("q-item",[a("q-item-section",[a("q-item-label",[a("h1",[t._v("Добавить материал")])])],1)],1),a("q-card-section",[a("p",[t._v("Выберите категорию: ")]),t.TreeCategoties.length?a("q-tree",{attrs:{nodes:t.TreeCategoties,"node-key":"id","label-key":"title",selected:t.post.category,"default-expand-all":"","no-connectors":"","selected-color":"accent"},on:{"update:selected":function(e){return t.$set(t.post,"category",e)}}}):t._e(),a("q-input",{attrs:{filled:"",label:"Название записи"},model:{value:t.post.title,callback:function(e){t.$set(t.post,"title",e)},expression:"post.title"}}),a("q-input",{staticStyle:{background:"#fff",color:"#000"},attrs:{type:"textarea",filled:"","editor-toolbar":[[{header:[2,3,4,5,6,!1]},{align:["justify","right","center"]}],["bold","italic","underline","strike"],[{list:"ordered"},{list:"bullet"}],["link","image","code-block","formula"],["clean"]]},model:{value:t.post.body,callback:function(e){t.$set(t.post,"body",e)},expression:"post.body"}}),a("q-uploader",{staticClass:"full-width",attrs:{label:"Прикрепите файлы",multiple:"","auto-upload":"","hide-upload-btn":"",factory:t.uploadFactory},on:{uploaded:t.uploadedFile},scopedSlots:t._u([{key:"list",fn:function(e){return[a("q-list",t._l(t.fileList,(function(e){return a("q-item",{key:e.id},[a("q-item-section",{attrs:{avatar:"",top:""}},[a("q-avatar",{attrs:{icon:"assignment",color:"grey","text-color":"white"}})],1),a("q-item-section",[a("q-item-label",{attrs:{lines:"1"}},[t._v(t._s(e.name))]),a("q-item-label",{attrs:{caption:""}},[t._v("Тип файла: "+t._s(e.type)+", объём:\n                                        "+t._s(Math.round(e.size/10.24)/100)+" КБ\n                                    ")])],1),a("q-item-section",{attrs:{align:"right"}},[a("q-btn-group",[a("q-btn",{attrs:{icon:"visibility",color:"positive",to:t.fileUrl(e)}}),a("q-btn",{attrs:{icon:"edit",color:"primary"},on:{click:function(a){return t.editFile(e)}}}),a("q-btn",{attrs:{icon:"delete",color:"negative"},on:{click:function(a){return t.removeFile(e)}}})],1)],1)],1)})),1)]}}])})],1),a("q-card-actions",{attrs:{align:"right"}},[a("q-btn-group",{attrs:{push:""}},[a("q-btn",{attrs:{label:"Очистить форму",color:"negative",align:"right"},on:{click:t.removeDraft}}),a("q-btn",{attrs:{label:"Отправить",color:"primary",align:"right"},on:{click:t.sendForm}})],1)],1)],1)],1)])},n=[],r=a("4db1"),o=a.n(r),s=(a("28a5"),a("7f7f"),a("967e")),l=a.n(s),c=(a("96cf"),a("fa84")),u=a.n(c),d=(a("b06b"),a("5873")),f=a("883c"),p=a.n(f);d["a"].register({"modules/better-table":p.a},!0);var h={name:"Publish",data:function(){return{categories:{load:!1,data:{}},post:{category:null,body:"",title:"",files:[]},fileList:[]}},methods:{updateCategories:function(){var t=this;return u()(l.a.mark((function e(){var a;return l.a.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,t.$axios.get("/categories");case 2:a=e.sent,t.categories.data=a.data.data,t.categories.load=!0;case 5:case"end":return e.stop()}}),e)})))()},loadDraft:function(){var t=localStorage.getItem("draftLastSave");if(t)try{t=JSON.parse(t),this.post=t,this.updateFileList()}catch(e){return}},saveDraft:function(){localStorage.setItem("draftLastSave",JSON.stringify(this.post))},updateFileList:function(){var t=this;return u()(l.a.mark((function e(){var a;return l.a.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(t.post.files.length){e.next=2;break}return e.abrupt("return",t.fileList=[]);case 2:return e.next=4,t.$axios.get("/files/many",{params:{ids:t.post.files}});case 4:a=e.sent,t.fileList=a.data.data;case 6:case"end":return e.stop()}}),e)})))()},editFile:function(t){var e=this;this.$q.dialog({title:"Редактировать файл",message:"Название файла",prompt:{model:t.name,type:"text",isValid:function(t){return t.length>2}},cancel:!0,persistent:!0}).onOk((function(a){e.$axios.patch("/files/"+t.id,{name:a}).then((function(){e.updateFileList()}))}))},removeFile:function(t){this.post.files=this.post.files.filter((function(e){return e!==t.id}))},uploadFactory:function(t){return!!this.authCheck()&&{url:this.$axios.defaults.baseURL+"/files",fieldName:"file",formFields:[{name:"name",value:t[0].name.split(".").reverse().splice(1).reverse().join(".")}],headers:[{name:"Authorization",value:this.$axios.defaults.headers.common.Authorization}]}},uploadedFile:function(t){this.post.files.push(JSON.parse(t.xhr.response).data.id)},fileUrl:function(t){return"/file/"+t.id},removeDraftAction:function(){this.post={category:null,body:"",title:"",files:[]}},removeDraft:function(){this.$q.dialog({title:"Очистить форму",message:"Вы действительно хотите удалить все несохраненные данные?",cancel:!0}).onOk(this.removeDraftAction)},sendForm:function(){var t=this;return u()(l.a.mark((function e(){var a;return l.a.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(t.post.category){e.next=2;break}return e.abrupt("return",t.$q.notify("Выберите категорию"));case 2:if(t.post.title){e.next=4;break}return e.abrupt("return",t.$q.notify("Заглавие отсутствует"));case 4:if(t.post.body){e.next=6;break}return e.abrupt("return",t.$q.notify("Содержимое отсутствует"));case 6:if(t.authCheck()){e.next=8;break}return e.abrupt("return");case 8:return a={title:t.post.title,category_id:t.post.category,body:t.post.body,files:t.post.files,type:0},t.$q.loading.show(),e.next=12,t.$axios.post("/posts/store",a);case 12:e.sent,t.$q.loading.hide(),t.$q.notify("Ваши материалы отправлены на модерацию. Спасибо за поддержку проекта!"),t.removeDraftAction();case 16:case"end":return e.stop()}}),e)})))()},authCheck:function(){var t=this;return!!this.$store.state.user.auth||(this.$q.dialog({title:"Сначала авторизируйтесь",message:"Чтобы опубликовать запись и добавлять файлы необходимо авторизироваться. Это необходимо для сохранения безопасности системы. Все введённые данные будут сохранены.",cancel:!1,persistent:!0,ok:"Авторизироваться"}).onOk((function(){t.$router.push("/login")})),!1)}},mounted:function(){this.updateCategories(),this.loadDraft()},computed:{TreeCategoties:function(){function t(e){return{id:e.id,title:e.title+" ("+e.posts.length+")",children:o()(e.children.map(t))}}return this.categories.load?this.categories.data.map(t):{}}},watch:{"post.title":function(){this.saveDraft()},"post.body":function(){this.saveDraft()},"post.category":function(){this.saveDraft()},"post.files":function(){this.saveDraft(),this.updateFileList()}},components:{VueEditor:d["b"]}},m=h,g=a("2877"),b=a("9989"),v=a("f09f"),y=a("66e5"),q=a("4074"),k=a("0170"),x=a("a370"),$=a("7f41"),w=a("27f9"),F=a("ee89"),Q=a("1c1c"),C=a("cb32"),L=a("e7a9"),_=a("9c40"),D=a("4b7e"),S=a("eebe"),A=a.n(S),O=Object(g["a"])(m,i,n,!1,null,null,null);e["default"]=O.exports;A()(O,"components",{QPage:b["a"],QCard:v["a"],QItem:y["a"],QItemSection:q["a"],QItemLabel:k["a"],QCardSection:x["a"],QTree:$["a"],QInput:w["a"],QUploader:F["a"],QList:Q["a"],QAvatar:C["a"],QBtnGroup:L["a"],QBtn:_["a"],QCardActions:D["a"]})}}]);