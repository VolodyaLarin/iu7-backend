(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[16],{"2b1d":function(t,e,a){"use strict";a.r(e);var i=function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("q-page",{staticClass:"q-pa-lg"},[a("div",[a("q-card",[a("q-item",[a("q-item-section",[a("q-item-label",[a("h1",[t._v("Редактирование записи: ")])])],1)],1),a("q-card-section",[a("p",[t._v("Выберите категорию: ")]),t.TreeCategoties.length?a("q-tree",{attrs:{nodes:t.TreeCategoties,"node-key":"id","label-key":"title",selected:t.post.category_id,"default-expand-all":"","no-connectors":"","selected-color":"accent"},on:{"update:selected":function(e){return t.$set(t.post,"category_id",e)}}}):t._e(),a("q-select",{attrs:{filled:"",options:t.statusOptions,label:"Статус","map-options":"","emit-value":""},model:{value:t.post.status,callback:function(e){t.$set(t.post,"status",e)},expression:"post.status"}}),a("q-input",{attrs:{filled:"",label:"Название записи"},model:{value:t.post.title,callback:function(e){t.$set(t.post,"title",e)},expression:"post.title"}}),a("vue-editor",{staticStyle:{background:"#fff",color:"#000"},attrs:{"editor-toolbar":[[{header:[2,3,4,5,6,!1]},{align:["justify","right","center"]}],["bold","italic","underline","strike"],[{list:"ordered"},{list:"bullet"}],["link","image","code-block","formula"],["clean"]]},model:{value:t.post.body,callback:function(e){t.$set(t.post,"body",e)},expression:"post.body"}}),a("q-uploader",{staticClass:"full-width",attrs:{label:"Прикрепите файлы",multiple:"","auto-upload":"","hide-upload-btn":"",factory:t.uploadFactory},on:{uploaded:t.uploadedFile},scopedSlots:t._u([{key:"list",fn:function(e){return[a("q-list",t._l(t.fileList,(function(e){return a("q-item",{key:e.id},[a("q-item-section",{attrs:{avatar:"",top:""}},[a("q-avatar",{attrs:{icon:"assignment",color:"grey","text-color":"white"}})],1),a("q-item-section",[a("q-item-label",{attrs:{lines:"1"}},[t._v(t._s(e.name))]),a("q-item-label",{attrs:{caption:""}},[t._v("Тип файла: "+t._s(e.type)+", объём:\n                                        "+t._s(Math.round(e.size/10.24)/100)+" КБ\n                                    ")])],1),a("q-item-section",{attrs:{align:"right"}},[a("q-btn-group",[a("q-btn",{attrs:{icon:"visibility",color:"positive",to:t.fileUrl(e)}}),a("q-btn",{attrs:{icon:"edit",color:"primary"},on:{click:function(a){return t.editFile(e)}}}),a("q-btn",{attrs:{icon:"delete",color:"negative"},on:{click:function(a){return t.removeFile(e)}}})],1)],1)],1)})),1)]}}])})],1),a("q-card-actions",{attrs:{align:"right"}},[a("q-btn-group",{attrs:{push:""}},[a("q-btn",{attrs:{icon:"link",label:"Просмотреть (без сохранения)",color:"negative",to:"/post/"+t.postId}}),a("q-btn",{attrs:{label:"Сохранить изменения",color:"primary",align:"right"},on:{click:t.sendForm}})],1)],1)],1)],1)])},n=[],s=a("4db1"),o=a.n(s),r=(a("f751"),a("28a5"),a("7f7f"),a("967e")),l=a.n(r),c=(a("96cf"),a("fa84")),u=a.n(c),d=(a("b06b"),a("5873")),p=(a("1487"),{name:"Post",data:function(){return{categories:{load:!1,data:{}},post:{},fileList:[]}},methods:{updateFile:function(){var t=this;return u()(l.a.mark((function e(){var a;return l.a.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,t.$axios.get("/categories");case 2:a=e.sent,t.categories.data=a.data.data,t.categories.load=!0;case 5:case"end":return e.stop()}}),e)})))()},updateCategories:function(){var t=this;return u()(l.a.mark((function e(){var a;return l.a.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,t.$axios.get("/categories");case 2:a=e.sent,t.categories.data=a.data.data,t.categories.load=!0;case 5:case"end":return e.stop()}}),e)})))()},updateFileList:function(){var t=this;return u()(l.a.mark((function e(){var a;return l.a.wrap((function(e){while(1)switch(e.prev=e.next){case 0:if(t.post.files.length){e.next=2;break}return e.abrupt("return",t.fileList=[]);case 2:return e.next=4,t.$axios.get("/files/many",{params:{ids:t.post.files}});case 4:a=e.sent,t.fileList=a.data.data;case 6:case"end":return e.stop()}}),e)})))()},editFile:function(t){var e=this;this.$q.dialog({title:"Редактировать файл",message:"Название файла",prompt:{model:t.name,type:"text",isValid:function(t){return t.length>2}},cancel:!0,persistent:!0}).onOk((function(a){e.$axios.patch("/files/"+t.id,{name:a}).then((function(){e.updateFileList()}))}))},removeFile:function(t){this.post.files=this.post.files.filter((function(e){return e!==t.id}))},uploadFactory:function(t){return!!this.authCheck()&&{url:this.$axios.defaults.baseURL+"/files",fieldName:"file",formFields:[{name:"name",value:t[0].name.split(".").reverse().splice(1).reverse().join(".")}],headers:[{name:"Authorization",value:this.$axios.defaults.headers.common.Authorization}]}},uploadedFile:function(t){this.post.files.push(JSON.parse(t.xhr.response).data.id)},fileUrl:function(t){return"/file/"+t.id},sendForm:function(){var t=this;return u()(l.a.mark((function e(){return l.a.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return t.$q.loading.show(),e.next=3,t.$axios.patch("/moderator/posts/".concat(t.postId),t.post);case 3:return e.next=5,t.updatePost();case 5:t.$q.loading.hide(),t.$q.notify("Изменения сохранены!");case 7:case"end":return e.stop()}}),e)})))()},updatePost:function(){var t=this;return u()(l.a.mark((function e(){var a,i;return l.a.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return e.next=2,t.$axios("/moderator/posts/".concat(t.postId)).catch((function(){}));case 2:a=e.sent,i=Object.assign(a.data.data),i.files=i.files.map((function(t){return t.id})),t.post=i;case 6:case"end":return e.stop()}}),e)})))()}},mounted:function(){this.updatePost(),this.updateCategories()},computed:{TreeCategoties:function(){function t(e){return{id:e.id,title:e.title+" ("+e.posts.length+")",children:o()(e.children.map(t))}}return this.categories.load?this.categories.data.map(t):{}},postId:function(){return this.$route.params.post},statusOptions:function(){return[{label:"На модерации",value:0},{label:"Опубликовано",value:1},{label:"Отказано в публикации",value:-1}]}},watch:{"post.files":function(){this.updateFileList()}},components:{VueEditor:d["b"]}}),f=p,h=a("2877"),m=a("9989"),b=a("f09f"),g=a("66e5"),v=a("4074"),q=a("0170"),x=a("a370"),k=a("7f41"),w=a("ddd8"),y=a("27f9"),$=a("ee89"),F=a("1c1c"),Q=a("cb32"),_=a("e7a9"),C=a("9c40"),L=a("4b7e"),I=a("eebe"),O=a.n(I),S=Object(h["a"])(f,i,n,!1,null,null,null);e["default"]=S.exports;O()(S,"components",{QPage:m["a"],QCard:b["a"],QItem:g["a"],QItemSection:v["a"],QItemLabel:q["a"],QCardSection:x["a"],QTree:k["a"],QSelect:w["a"],QInput:y["a"],QUploader:$["a"],QList:F["a"],QAvatar:Q["a"],QBtnGroup:_["a"],QBtn:C["a"],QCardActions:L["a"]})}}]);